<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>workerman-chat PHP聊天室 Websocket(HTLM5/Flash)+PHP多进程socket实时推送技术</title>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/jquery-sinaEmotion-2.1.0.min.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">

    <script type="text/javascript" src="./js/swfobject.js"></script>
    <script type="text/javascript" src="./js/web_socket.js"></script>
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="./js/jquery-sinaEmotion-2.1.0.min.js"></script>
    <script src="https://cdn.bootcss.com/socket.io/2.3.0/socket.io.js"></script>

</head>
<body onload="connect();">
<div class="container">
    <div class="row clearfix">
        <div class="col-md-1 column">
        </div>
        <div class="col-md-6 column">
            <div class="thumbnail">
                <div class="caption" id="dialog"></div>
            </div>
            <form onsubmit="onSubmit(); return false;">
                <select style="margin-bottom:8px" id="client_list">
                    <option value="all">所有人</option>
                </select>
                <textarea class="textarea thumbnail" id="textarea"></textarea>
                <div class="say-btn">
                    <input type="button" class="btn btn-default face pull-left" value="表情"/>
                    <input type="submit" class="btn btn-default" value="发表"/>
                </div>
            </form>
            <div>
                &nbsp;&nbsp;&nbsp;&nbsp;<b>房间列表:</b>（当前在&nbsp;房间<?php echo isset($_GET['room_id']) && intval($_GET['room_id']) >
                0 ? intval($_GET['room_id']) : 1; ?>
                ）<br>
                &nbsp;&nbsp;&nbsp;&nbsp;<a href="/?room_id=1">房间1</a>&nbsp;&nbsp;&nbsp;&nbsp;<a
                    href="/?room_id=2">房间2</a>&nbsp;&nbsp;&nbsp;&nbsp;<a
                    href="/?room_id=3">房间3</a>&nbsp;&nbsp;&nbsp;&nbsp;<a
                    href="/?room_id=4">房间4</a>
                <br><br>
            </div>
            <p class="cp">PHP多进程+Websocket(HTML5/Flash)+PHP Socket实时推送技术&nbsp;&nbsp;&nbsp;
                &nbsp;Powered by <a href="http://www.workerman.net/workerman-chat" target="_blank">pegion-chat</a>
            </p>
        </div>
        <div class="col-md-3 column">
            <div class="thumbnail">
                <div class="caption" id="userlist"></div>
            </div>
            <a href="http://workerman.net:8383" target="_blank"><img
                    style="width:252px;margin-left:5px;" src="./img/workerman-todpole.png"></a>
        </div>
    </div>
</div>

<script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F7b1919221e89d2aa5711e4deb935debd' type='text/javascript'%3E%3C/script%3E"));
</script>

<script type="text/javascript">
    // 动态自适应屏幕
    document.write('<meta name="viewport" content="width=device-width,initial-scale=1">');
    $("textarea").on("keydown", function (e) {
        // 按enter键自动提交
        if (e.keyCode === 13 && !e.ctrlKey) {
            e.preventDefault();
            $('form').submit();
            return false;
        }

        // 按ctrl+enter组合键换行
        if (e.keyCode === 13 && e.ctrlKey) {
            $(this).val(function (i, val) {
                return val + "\n";
            });
        }
    });
</script>
</body>
</html>
<script type="text/javascript">
    var socket, name, client_list = {};

    function connect() {
        var socket = io('ws://127.0.0.1:9502',
            {
                transports: ["websocket"],
                query: "uid=312888&token=7ba6b385e91c1bfb14dd6f7bd6d5601d"
            },);
        // {transports: ["websocket"],query:"uid=70001&token=token"},);
        socket.on('connect', data => {
            login_data=  onopen()
            // ws.send(login_data);
            console.log("websocket握手成功，发送登录数据:" + login_data);
        });
        socket.on('connect_error', function (data) {
            console.log(JSON.stringify(data) + ' - connect_error');
        })
    }


    // 连接建立时发送登录信息
    function onopen() {
        if (!name) {
            show_prompt();
        }

        // 登录
        return '{"type":"login","client_name":"' + name.replace(/"/g, '\\"') + '","room_id":"1"}';


    }

    // 输入姓名
    function show_prompt() {
        name = prompt('输入你的名字：', '');
        if (!name || name == 'null') {
            name = '游客';
        }
    }


</script>